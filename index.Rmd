---
title: "COVID-19 in Virginia"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code: https://github.com/joseph-ellis/va-covid
    theme: paper
runtime: shiny
---

<!-- TODO - Move any style written here to its own CSS file -->
<style>
  .chart-title {
    color: #FFFFFF;
    background-color: #0D3C61;
    border-color: #0D3C61;
    border-radius: 3px 3px 0px 0px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
  }
  
  .chart-title-text {
    color: #FFFFFF;
  }
  
  .chart-wrapper {
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3)
  }

  .panel {
    margin-top: 10px;
  }
  
  .panel-heading {
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
  }
  
  .panel-title {
    font-size: 18px;
  }
  
  td:first-child {
    font-weight: bold;
  }
  
  ul {
    list-style-type: none;
  }
  
  .value-box {
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3)
  }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE
)
 # load necessary packages
library(config)
library(flexdashboard)
library(lubridate)
library(RSocrata)
library(scales)
library(shiny)
library(shinyjs)
library(shinythemes)
library(shinyWidgets)
library(tidyverse)
library(highcharter)

# load globals
source("R/global.R")

# load necessary components
source("components/highChartSingleLineDate.R")
source("components/highChartMultiLineDate.R")
source("components/highChartAreaLineDate.R")
source("components/highChartMultiAreaLineDate.R")
source("components/highChartVAChloroplethMap.R")

# load all data
covid <- readRDS("data/covid.rds")

# initialize reactive values object
rv <- reactiveValues()

```

```{r globals}

# metrics showing counted values
metricsCount <- c(
  "Total Cases",
  "Total Hospitalizations",
  "Total Deaths"
)

# metrics showing rates
metricsRate <- c(
  "Cases per 100K",
  "Hospitalization Rate",
  "Hospitalization per 100K",
  "Mortality Rate",
  "Deaths per 100K"
)

# metrics showing daily new values
metricsNew <- c(
  "New Cases",
  "New Hospitalizations",
  "New Deaths"
)

# date of last data update
dataDate <- covid$SCNMS$Date[1] %>%
  ReadableDate()

# common subtitle for charts
chartSubtitle <- paste0(
  "Data reported by the Virginia Department of Health as of ", 
  dataDate
)

```

State Metric Summary {data-navmenu="State"}
================================================================================

Sidebar {.sidebar}
--------------------------------------------------------------------------------
```{r sidebar_state-summary}

# user input panel
panel(
  heading = "User Inputs",
  status = "primary",
  prettyRadioButtons(
    inputId = "stateSummaryChartType",
    label = "What to plot...", 
    choices = c(
      "Cumulative Totals",
      "Daily New Values"
    ),
    icon = icon("check"), 
    bigger = TRUE,
    status = "primary"
  ),
  pickerInput(
    inputId = "stateSummaryMetric",
    label = "Choose a metric...", 
    choices = list(
      Counts = metricsCount,
      Rates = metricsRate
    ),
    selected = "Total Cases"
  )
)

# change metrics in the dropdown menu based on selected chart type
# FIRES ON CHART TYPE CHANGE
observeEvent(
  label = "stateSummaryChartTypeSelection",
  input$stateSummaryChartType, {
    metricChoices <- switch(
      input$stateSummaryChartType,
      "Cumulative Totals" = list(
        Counts = metricsCount,
        Rates = metricsRate
      ),
      "Daily New Values" = metricsNew
    )
    
    updatePickerInput(
      session = session,
      inputId = "stateSummaryMetric",
      choices = metricChoices
    )
  }
)

```

Row
--------------------------------------------------------------------------------
### Total Cases
```{r value-box_state_total-cases}

# display total cases
valueBox(
  value = format(
    covid$SCMS$TotalCases, 
    big.mark = ","
  ),
  caption = "Total Cases in Virginia",
  icon = "fa-thermometer-three-quarters",
  color = "danger"
)

```

### Hospitalizations
```{r value-box_state_hospitalizations}

# display total hospitalizations
valueBox(
  value = format(
    covid$SCMS$Hospitalizations, 
    big.mark = ","
  ),
  caption = "Total Hospitalizations in Virginia",
  icon = "fa-hospital",
  color = "danger"
)

```

### Deaths
```{r value-box_state_deaths}

# display total deaths
valueBox(
  value = format(
    covid$SCMS$Deaths, 
    big.mark = ","
  ),
  caption = "Total Deaths in Virginia",
  icon = "fa-ambulance",
  color = "danger"
)

```

Row
--------------------------------------------------------------------------------
### Cases per 100K
```{r value-box_state_cases-100k}

# display cases per 100K 
valueBox(
  value = format(
    round(covid$SCMS$CasesPer100K),
    big.mark = ","
  ),
  caption = "Cases per 100K People in Virginia",
  icon = "fa-users",
  color = "warning"
)

```

### Hospitalizations Rate
```{r value-box_state_hospital_rate}

# display hospitalization rate
valueBox(
  value = percent(
    covid$SCMS$PercentCasesHospitalized, 
    accuracy = 0.1
  ),
  caption = "Hospitalization Rate in Virginia",
  icon = "fa-hospital",
  color = "warning"
)

```

### Mortality Rate
```{r value-box_state_mortality_rate}

# display mortality rate
valueBox(
  value = percent(
    covid$SCMS$MortalityRate, 
    accuracy = 0.1
  ),
  caption = "Mortality Rate in Virginia",
  icon = "fa-ambulance",
  color = "warning"
)

```

Row
--------------------------------------------------------------------------------

### `r renderUI(HTML("<h5 class='chart-title-text'>State Summary Metrics</h5>"))`
```{r hc_state_summary}

# reactive object for chart data
# FIRES ON METRIC VALUE CHANGE
stateSummaryChartData <- eventReactive(
  label = "stateSummarySetChartData",
  input$stateSummaryMetric, {
    chosenMetric <- switch(
      input$stateSummaryMetric,
      "Total Cases" = "TotalCases",
      "Total Hospitalizations" = "Hospitalizations",
      "Total Deaths" = "Deaths",
      "Cases per 100K" = "CasesPer100K",
      "Hospitalization Rate" = "PercentCasesHospitalized",
      "Hospitalization per 100K" = "HospitalizationsPer100K",
      "Mortality Rate" = "MortalityRate",
      "Deaths per 100K" = "DeathsPer100K",
      "New Cases" = "NewCases",
      "New Hospitalizations" = "NewHospitalizations",
      "New Deaths" = "NewDeaths" 
    )
    
    chosenAverage <- switch(
      input$stateSummaryMetric,
      "New Cases" = "NewCases_7MA",
      "New Hospitalizations" = "NewHospitalizations_7MA",
      "New Deaths" = "NewDeaths_7MA" 
    )
    
    output <- switch(
      input$stateSummaryChartType,
      "Cumulative Totals" = covid$SMSBD %>% 
        select(
          "plotX" = Date, 
          "plotY" = all_of(chosenMetric)
        ),
      "Daily New Values" = covid$SNMSBD %>% 
        select(
          "plotX" = Date, 
          "plotYC" = all_of(chosenMetric), 
          "plotYL" = all_of(chosenAverage)
        )
    )
  }
)

# reactive object for the y-axis title
# FIRES ON METRIC VALUE CHANGE
summaryYAxisTitle <- eventReactive(
  label = "summayYAxisTitle",
  input$stateSummaryMetric, {
    output <- input$stateSummaryMetric
  }
)

# reactive object to plot chart type based on selection
# FIRES ON METRIC VALUE CHANGE
stateSummaryPlotter <- eventReactive(
  input$stateSummaryMetric, {
    switch(
      input$stateSummaryChartType,
      "Cumulative Totals" = HighChartSingleLineDate(
        stateSummaryChartData, 
        summaryYAxisTitle
      ) %>%
        StyleSingleLineDate(
          summaryYAxisTitle, 
          chartSubtitle
        ),
      "Daily New Values" = HighChartAreaLineDate(
        stateSummaryChartData, 
        summaryYAxisTitle
      ) %>%
        StyleAreaLineDate(
          summaryYAxisTitle, 
          chartSubtitle
        )
    )
  }
)

# render the chart
renderHighchart(
  stateSummaryPlotter()
)

```

Health Planning Region Summary {data-navmenu="Health Planning Regions"}
================================================================================

Sidebar {.sidebar}
--------------------------------------------------------------------------------
```{r sidebar_hpr-summary}

# enable use of shinyjs
useShinyjs(rmd = TRUE)

# list of health planning regions for dropdown
hpr <- covid$HPRCMS %>%
  distinct(HealthPlanningRegion)
  
# list of health planning regions for dropdown with "All Regions" option
hprAll <- hpr %>%
  add_row(
    HealthPlanningRegion = "All Regions",
    .before = 1
  )

# initialize reactive value for health planning region comparison
rv$hprComparison <- 0

# user input panel
panel(
  heading = "User Inputs",
  status = "primary",
  prettyRadioButtons(
    inputId = "hprSummaryChartType",
    label = "What to plot...", 
    choices = c(
      "Cumulative Totals",
      "Daily New Values"
    ),
    icon = icon("check"), 
    bigger = TRUE,
    status = "primary"
  ),
  pickerInput(
    inputId = "hprSummaryMetric",
    label = "Choose a metric...", 
    choices = list(
      Counts = metricsCount,
      Rates = metricsRate
    ),
    selected = "Total Cases"
  ),
  pickerInput(
    inputId = "hpr",
    label = "Choose a planning region...", 
    choices = hpr
  ),
  hidden(
    pickerInput(
      inputId = "hprCompare",
      label = "Planning region to compare...",
      choices = NULL
    )
  )
)

# change metrics in the dropdown menus based on selected chart type
# FIRES ON CHART TYPE CHANGE
observeEvent(
  input$hprSummaryChartType, {
    metricChoices <- switch(
      input$hprSummaryChartType,
      "Cumulative Totals" = list(
        Counts = metricsCount,
        Rates = metricsRate
      ),
      "Daily New Values" = metricsNew
    )
  
    updatePickerInput(
      session = session,
      inputId = "hprSummaryMetric",
      choices = metricChoices
    )
  
    hprChoices <- switch(
      input$hprSummaryChartType,
      "Cumulative Totals" = hprAll,
      "Daily New Values" = hpr
    )
  
    updatePickerInput(
      session = session,
      inputId = "hpr",
      choices = hprChoices
    )
  
    if (input$hprSummaryChartType == "Cumulative Totals") {
      rv$hprComparison <- 0
    }
    else {
      rv$hprComparison <- 1
    }
  }
)

# show or hide comparison dropdown
# FIRES ON REACTIVE VALUE CHANGE
observeEvent(
  rv$hprComparison, {
    if (rv$hprComparison == 0) {
      hide(selector = "select[id='hprCompare']")
      
      updatePickerInput(
        inputId = "hprCompare",
        session = session,
        selected = "None"
      )
    }
    else {
      show(selector = "select[id='hprCompare']")
      
      hprNone <- covid$HPRCMS %>%
        filter(HealthPlanningRegion != input$hpr) %>%
        distinct(HealthPlanningRegion) %>%
        add_row(
          HealthPlanningRegion = "None",
          .before = 1
        )
      
      updatePickerInput(
        inputId = "hprCompare",
        session = session,
        choices = hprNone,
        selected = "None"
      )
    }
})

# reactive object to hold primary health planning region data
chosenHPRData <- reactive(
  covid$HPRCMS %>%
    filter(HealthPlanningRegion == input$hpr)
)

# reactive object to hold second health planning region data for comparison
chosenComparisonData <- reactive(
  covid$HPRCMS %>%
    filter(HealthPlanningRegion == input$hprComparison)
)

# reactive object to build the data set for the page
# FIRES ON CHANGE TO BOTH HEALTH PLANNING REGION CHANGES
hprData <- eventReactive(
  c(input$hpr, input$hprCompare), {
    if (input$hprCompare == "None") {
      chosenHPRData()
    }
    else {
      bind_rows(chosenHPRData(), chosenComparisonData())
    }
  }
)

# reactive object to hold the health districts within the selected health
# planning region
# FIRES ON PRIMARY HEALTH PLANNING REGION CHANGE
districtsIncluded <- eventReactive(
  input$hpr, {
    districts <- covid$LCMS %>%
      filter(HealthPlanningRegion == input$hpr) %>%
      distinct(HealthDistrict)
  
    htmlString <- ""
  
    for (i in 1:nrow(districts)) {
      htmlString <- paste0(
        htmlString,
        "<li>",
        districts$HealthDistrict[i],
        "</li>"
      )
    }
  
    return(htmlString)
  }
)

# UI element to display the health districts within the chosen health planning
# region
panel(
  heading = "Health Districts",
  status = "warning",
  renderUI({
    HTML(
      paste0(
        "The <strong>", 
        input$hpr, 
        "</strong> health planning region includes the following districts:"
      )
    )
  }),
  renderUI({
    HTML(
      paste0(
        "<br /><ul>",
        districtsIncluded(),
        "</ul>"
      )
    )
  })
)

# show or hide the health districts panel
# FIRES ON PRIMARY HEALTH PLANNING REGION CHANGE
observeEvent(
  input$hpr, {
    if (input$hpr == "All Regions") {
      hide(selector = "div[class='panel panel-warning']")
    }
    else {
      show(selector = "div[class='panel panel-warning']")
    }
  }
)

```

Row
-------------------------------------------------------------------------------
### Total Cases
```{r value-box_hpr_total-cases}

# display total cases
renderValueBox({
  if (input$hpr == "All Regions") {
    valueBox(
      value = format(
        covid$SCMS$TotalCases, 
        big.mark = ","
      ),
      caption = "Total Cases in Virginia",
      icon = "fa-thermometer-three-quarters",
      color = "danger"
    )
  }
  else {
    valueBox(
      value = format(
        chosenHPRData()$TotalCases, 
        big.mark = ","
      ),
      caption = paste0(
        "Total Cases in the ", 
        input$hpr, 
        " Health Planning Region"
      ),
      icon = "fa-thermometer-three-quarters",
      color = "danger"
    )
  }
})

```

### Hospitalizations
```{r value-box_hpr_hospitalizations}

# display total hospitalizations
renderValueBox({
  if (input$hpr == "All Regions") {
    valueBox(
      value = format(
        covid$SCMS$Hospitalizations, 
        big.mark = ","
      ),
      caption = "Total Hospitalizations in Virginia",
      icon = "fa-hospital",
      color = "danger"
    )
  }
  else {
    valueBox(
      value = format(
        chosenHPRData()$Hospitalizations, 
        big.mark = ","
      ),
      caption = paste0(
        "Total Hospitalizations in the ", 
        input$hpr, 
        " Health Planning Region"
      ),
      icon = "fa-hospital",
      color = "danger"
    )
  }
})

```

### Deaths
```{r value-box_hpr_deaths}

# display total deaths
renderValueBox({
  if (input$hpr == "All Regions") {
    valueBox(
      value = format(
        covid$SCMS$Deaths, 
        big.mark = ","
      ),
      caption = "Total Deaths in Virginia",
      icon = "fa-ambulance",
      color = "danger"
    )
  }
  else {
    valueBox(
      value = format(
        chosenHPRData()$Deaths, 
        big.mark = ","
      ),
      caption = paste0(
        "Total Deaths in the ", 
        input$hpr, 
        " Health Planning Region"
      ),
      icon = "fa-ambulance",
      color = "danger"
    )
  }
})

```

Row
-------------------------------------------------------------------------------
### Cases per 100K
```{r value-box_hpr_cases-100k}

# display cases per 100K
renderValueBox({
  if (input$hpr == "All Regions") {
    valueBox(
      value = format(
        round(covid$SCMS$CasesPer100K),
        big.mark = ","
      ),
      caption = "Cases per 100K People in Virginia",
      icon = "fa-users",
      color = "warning"
    )
  }
  else {
    valueBox(
      value = format(
        round(chosenHPRData()$CasesPer100K),
        big.mark = ","
      ),
      caption = paste0(
        "Cases per 100K People in the ", 
        input$hpr, 
        " Health Planning Region"
      ),
      icon = "fa-users",
      color = "warning"
    )
  }
})

```

### Hospitalizations Rate
```{r value-box_hpr_hospital_rate}

# display hospitalization rate
renderValueBox({
  if (input$hpr == "All Regions") {
    valueBox(
      value = percent(
        covid$SCMS$PercentCasesHospitalized, 
        accuracy = 0.1
      ),
      caption = "Hospitalization Rate in Virginia",
      icon = "fa-hospital",
      color = "warning"
    )
  }
  else {
    valueBox(
      value = percent(
        chosenHPRData()$PercentCasesHospitalized, 
        accuracy = 0.1
      ),
      caption = paste0(
        "Hospitalization Rate in the ", 
        input$hpr, 
        " Health Planning Region"
      ),
      icon = "fa-hospital",
      color = "warning"
    )
  }
})

```

### Mortality Rate
```{r value-box_hpr_mortality_rate}

# display mortality rate
renderValueBox({
  if (input$hpr == "All Regions") {
    valueBox(
      value = percent(
        covid$SCMS$MortalityRate, 
        accuracy = 0.1
      ),
      caption = "Mortality Rate in Virginia",
      icon = "fa-ambulance",
      color = "warning"
    )
  }
  else {
    valueBox(
      value = percent(
        chosenHPRData()$MortalityRate, 
        accuracy = 0.1
      ),
      caption = paste0(
        "Mortality rate in the ", 
        input$hpr, 
        " Health Planning Region"
      ),
      icon = "fa-ambulance",
      color = "warning"
    )
  }
})

```

Row
-------------------------------------------------------------------------------

### `r renderUI(HTML("<h5 class='chart-title-text'> Health Planning Region Summary Metrics"))`
```{r hc_hpr_summary}

# force metric value reset
# FIRES ON PRIMARY HEALTH PLANNING REGION CHANGE
observeEvent(
  input$hpr, {
    switch(
      input$hprSummaryChartType,
      "Cumulative Totals" = updatePickerInput(
        session = session,
        inputId = "hprSummaryMetric",
        selected = "Total Cases"
      ),
      "Daily New Values" = updatePickerInput(
        session = session,
        inputId = "hprSummaryMetric",
        selected = "New Cases"
      )
    )
  }
)

# reactive object for chart data
# FIRES ON PRIMARY AND SECONDARY HEALTH PLANNING REGION CHANGE AND METRIC VALUE
# CHANGE
hprSummaryChartData <- eventReactive(
  c(input$hpr, input$hprCompare, input$hprSummaryMetric), {
    chosenMetric <- switch(
      input$hprSummaryMetric,
      "Total Cases" = "TotalCases",
      "Total Hospitalizations" = "Hospitalizations",
      "Total Deaths" = "Deaths",
      "Cases per 100K" = "CasesPer100K",
      "Hospitalization Rate" = "PercentCasesHospitalized",
      "Hospitalization per 100K" = "HospitalizationsPer100K",
      "Mortality Rate" = "MortalityRate",
      "Deaths per 100K" = "DeathsPer100K",
      "New Cases" = "NewCases",
      "New Hospitalizations" = "NewHospitalizations",
      "New Deaths" = "NewDeaths"
    )
  
    chosenAverage <- switch(
      input$hprSummaryMetric,
      "New Cases" = "NewCases_7MA",
      "New Hospitalizations" = "NewHospitalizations_7MA",
      "New Deaths" = "NewDeaths_7MA"
    )
  
    output <- switch(
      input$hprSummaryChartType,
      "Cumulative Totals" = if (input$hpr == "All Regions") {
        covid$HPRMSBD %>%
        select(
          "plotX" = Date, 
          "plotGroup" = HealthPlanningRegion, 
          "plotY" = all_of(chosenMetric)
        )
      }
      else {
        covid$HPRMSBD %>%
        filter(HealthPlanningRegion == input$hpr) %>%
        select(
          "plotX" = Date, 
          "plotY" = all_of(chosenMetric)
        )
      },
      "Daily New Values" = if (input$hprCompare == "None") {
        covid$HPRNMSBD %>%
          filter(HealthPlanningRegion == input$hpr) %>%
          select(
            "plotX" = Date, 
            "plotYC" = all_of(chosenMetric), 
            "plotYL" = all_of(chosenAverage)
          )
      }
      else {
        covid$HPRNMSBD %>%
          filter(HealthPlanningRegion %in% c(input$hpr, input$hprCompare)) %>%
          select(
            "plotX" = Date, 
            "plotGroup" = HealthPlanningRegion, 
            "plotYC" = all_of(chosenMetric), 
            "plotYL" = all_of(chosenAverage)
          )
      }
    )
  }
)

# reactive object for the y-axis title
# FIREST ON METRIC VALUE CHANGE
hprSummaryYAxisTitle <- eventReactive(
  input$hprSummaryMetric, {
    output <- input$hprSummaryMetric
  }
)

# reactive object to plot chart type based on selection
# FIRES ON PRIMARY AND SECONDARY HEALTH PLANNING REGION CHANGE AND METRIC VALUE
# CHANGE
hprSummaryPlotter <- eventReactive(
  c(input$hpr, input$hprCompare, input$hprSummaryMetric), {
    switch(
      input$hprSummaryChartType,
      "Cumulative Totals" = if (input$hpr == "All Regions") {
        HighChartMultiLineDate(
          hprSummaryChartData, 
          hprSummaryYAxisTitle
        ) %>%
        StyleMultiLineDate(
          hprSummaryYAxisTitle, 
          chartSubtitle
        )
      }
      else {
        HighChartSingleLineDate(
          hprSummaryChartData, 
          hprSummaryYAxisTitle
        ) %>%
        StyleSingleLineDate(
          hprSummaryYAxisTitle, 
          chartSubtitle
        )
      },
      "Daily New Values" = if (input$hprCompare == "None") {
        HighChartAreaLineDate(
          hprSummaryChartData, 
          hprSummaryYAxisTitle
        ) %>%
        StyleAreaLineDate(
          hprSummaryYAxisTitle, 
          chartSubtitle
        )
      }
      else {
        HighChartMultiAreaLineDate(
          hprSummaryChartData, 
          hprSummaryYAxisTitle
        ) %>%
        StyleMultiAreaLineDate(
          hprSummaryYAxisTitle, 
          chartSubtitle
        )
      }
    )
  }
)

# render the chart
renderHighchart(
  hprSummaryPlotter()
)

```

Locality Metrics
===============================================================================

Sidebar {.sidebar}
-------------------------------------------------------------------------------
```{r sidebar_locality-summary}

# user input panel
panel(
  heading = "User Inputs",
  status = "primary",
  pickerInput(
    inputId = "localitySummaryMetric",
    label = "Choose a metric...", 
    choices = list(
      Counts = metricsCount,
      Rates = metricsRate
    ),
    selected = "Total Cases"
  )
)

chosenLocality <- reactive(input$mapClick)
```

Row {data-height=350}
-------------------------------------------------------------------------------

### `r renderUI(HTML(rv$localityTotalSummaryTitle))`
```{r hc_locality_total-summary}

rv$localityTotalSummaryTitle <- "<h5 class='chart-title-text'>Totals By Date for Virginia</h5>"
  
observeEvent(input$mapClick, {
  if (is.null(chosenLocality())) {
    rv$localityTotalSummaryTitle <- "<h5 class='chart-title-text'>Totals By Date for Virginia</h5>"
  }
  else {
    rv$localityTotalSummaryTitle <- paste0(
      "<h5 class='chart-title-text'>Totals By Date for ",
       chosenLocality(),
      "</h5>"
    )
  }
})

# reactive object for chart data
localitySummaryTotalChartData <- eventReactive(c(input$localitySummaryMetric, input$mapClick), {
  chosenMetric <- switch(
    input$localitySummaryMetric,
    "Total Cases" = "TotalCases",
    "Total Hospitalizations" = "Hospitalizations",
    "Total Deaths" = "Deaths",
    "Cases per 100K" = "CasesPer100K",
    "Hospitalization Rate" = "PercentCasesHospitalized",
    "Hospitalization per 100K" = "HospitalizationsPer100K",
    "Mortality Rate" = "MortalityRate",
    "Deaths per 100K" = "DeathsPer100K" 
  )
  
  output <- if (is.null(chosenLocality())) {
    covid$SMSBD %>% 
      select("plotX" = Date, "plotY" = all_of(chosenMetric))
  }
  else {
    covid$LMSBD %>%
      filter(Locality == chosenLocality()) %>%
      select("plotX" = Date, "plotY" = all_of(chosenMetric))
  }
})

# reactive object for the y-axis title
summaryTotalYAxisTitle <- eventReactive(input$localitySummaryMetric, {
  output <- input$localitySummaryMetric
})

# render the chart
renderHighchart({
  HighChartSingleLineDate(localitySummaryTotalChartData, summaryTotalYAxisTitle) %>%
      StyleSingleLineDate(summaryTotalYAxisTitle, chartSubtitle)
})

```

### `r renderUI(HTML(rv$localityNewSummaryTitle))`
```{r hc_locality_new-summary}
rv$localityNewSummaryTitle <- "<h5 class='chart-title-text'>New By Date for Virginia</h5>"
  
observeEvent(input$mapClick, {
  if (is.null(chosenLocality())) {
    rv$localityNewSummaryTitle <- "<h5 class='chart-title-text'>New By Date for Virginia</h5>"
  }
  else {
    rv$localityNewSummaryTitle <- paste0(
      "<h5 class='chart-title-text'>New By Date for ",
       chosenLocality(),
      "</h5>"
    )
  }
})

# reactive object for chart data
localitySummaryNewChartData <- eventReactive(c(input$localitySummaryMetric, input$mapClick), {
  chosenMetric <- switch(
    input$localitySummaryMetric,
    "Total Cases" = "NewCases",
    "Total Hospitalizations" = "NewHospitalizations",
    "Total Deaths" = "NewDeaths",
    "Cases per 100K" = "NewCases",
    "Hospitalization Rate" = "NewHospitalizations",
    "Hospitalization per 100K" = "NewHospitalizations",
    "Mortality Rate" = "NewDeaths",
    "Deaths per 100K" = "NewDeaths" 
  )
  
  chosenAverage <- switch(
    input$localitySummaryMetric,
    "Total Cases" = "NewCases_7MA",
    "Total Hospitalizations" = "NewHospitalizations_7MA",
    "Total Deaths" = "NewDeaths_7MA",
    "Cases per 100K" = "NewCases_7MA",
    "Hospitalization Rate" = "NewHospitalizations_7MA",
    "Hospitalization per 100K" = "NewHospitalizations_7MA",
    "Mortality Rate" = "NewDeaths_7MA",
    "Deaths per 100K" = "NewDeaths_7MA"
  )
  
  chosenLocality <- input$mapClick
  
  output <- if (is.null(chosenLocality)) {
    covid$SNMSBD %>% 
      select("plotX" = Date, "plotYC" = all_of(chosenMetric), "plotYL" = all_of(chosenAverage))
  }
  else {
    covid$LNMSBD %>%
      filter(Locality == chosenLocality) %>%
      select("plotX" = Date, "plotYC" = all_of(chosenMetric), "plotYL" = all_of(chosenAverage))
  }
})

# reactive object for the y-axis title
summaryNewYAxisTitle <- eventReactive(input$localitySummaryMetric, {
  output <- switch(
    input$localitySummaryMetric,
    "Total Cases" = "New Cases",
    "Total Hospitalizations" = "New Hospitalizations",
    "Total Deaths" = "New Deaths",
    "Cases per 100K" = "New Cases",
    "Hospitalization Rate" = "New Hospitalizations",
    "Hospitalization per 100K" = "New Hospitalizations",
    "Mortality Rate" = "New Deaths",
    "Deaths per 100K" = "New Deaths"
  )
})

# render the chart
renderHighchart({
  HighChartAreaLineDate(localitySummaryNewChartData, summaryNewYAxisTitle) %>%
      StyleAreaLineDate(summaryNewYAxisTitle, chartSubtitle)
})

```

Row
-------------------------------------------------------------------------------

### `r renderUI(HTML("<h5 class='chart-title-text'>Locality Map - Current Metrics</h5>"))`
```{r hm_locality_summary, fig.width=15}

# reactive object for chart data
localitySummaryMapData <- eventReactive(input$localitySummaryMetric, {
  chosenMetric <- switch(
    input$localitySummaryMetric,
    "Total Cases" = "TotalCases",
    "Total Hospitalizations" = "Hospitalizations",
    "Total Deaths" = "Deaths",
    "Cases per 100K" = "CasesPer100K",
    "Hospitalization Rate" = "PercentCasesHospitalized",
    "Hospitalization per 100K" = "HospitalizationsPer100K",
    "Mortality Rate" = "MortalityRate",
    "Deaths per 100K" = "DeathsPer100K",
    "New Cases" = "NewCases",
    "New Hospitalizations" = "NewHospitalizations",
    "New Deaths" = "NewDeaths" 
  )
  
  output <- covid$LCMS %>%
      select(fips, Locality, "plotValue" = all_of(chosenMetric))
})

# reactive object for the y-axis title
summaryMapTitle <- eventReactive(input$localitySummaryMetric, {
  output <- input$localitySummaryMetric
})

# render the chart
renderHighchart({
  HighChartVAChloroplethMap(localitySummaryMapData, "plotValue", summaryMapTitle)
})

```

### `r renderUI(HTML("<h5 class='chart-title-text'>Quick Summary</h5>"))`
```{r hm_locality_quick_summary}

quickSummaryData <- eventReactive(input$mapClick, {
  chosenLocality <- input$mapClick
  
  totals <- covid$LCMS %>%
    filter(Locality == chosenLocality) %>%
    select(
      Locality,
      "Population" = Population2019,
      "Total Cases" = TotalCases,
      "Total Hospitalizations" = Hospitalizations,
      "Total Deaths" = Deaths,
      "Cases per 100K" = CasesPer100K,
      "Hospitalization Rate" = PercentCasesHospitalized,
      "Hospitalizations per 100K" = HospitalizationsPer100K,
      "Mortality Rate" = MortalityRate,
      "Deaths per 100K" = DeathsPer100K
    ) %>%
    mutate(
      across(
        .cols = contains("Rate"),
        .fns = ~ percent(.x, accuracy = 0.1)
      ),
      across(
        .cols = where(is.numeric),
        .fns = ~ round(.x, digits = 2)
      ),
      across(
        .cols = where(is.numeric),
        .fns = ~ format(.x, big.mark = ",")
      )
    ) %>%
    pivot_longer(
      cols = c(2:10),
      names_to = "Metrics",
      values_to = "Value"
    )
  
  new <- covid$LCNMS %>%
    filter(Locality == chosenLocality) %>%
    select(
      Locality,
      "New Cases" = NewCases,
      "New Hospitalizations" = NewHospitalizations,
      "New Deaths" = NewDeaths
    ) %>%
    pivot_longer(
      cols = c(2:4),
      names_to = "Metrics",
      values_to = "Value"
    ) %>%
    mutate(
      across(
        .cols = where(is.numeric),
        .fns = ~ format(.x, big.mark = ",")
      )
    )
  
  output <- bind_rows(totals, new)
})

renderTable(
  quickSummaryData()[, 2:3],
  spacing = "xs",
  align = c("lr")
)

```
